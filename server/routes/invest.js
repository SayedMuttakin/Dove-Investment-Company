import express from 'express';
import Package from '../models/Package.js';
import User from '../models/User.js';
import { authMiddleware } from '../middleware/auth.js';
import { distributeCommissions } from '../utils/teamCommissions.js';
import { createNotification } from '../utils/notifications.js';

const router = express.Router();

// Get all investment packages
router.get('/packages', authMiddleware, async (req, res) => {
    try {
        const user = await User.findById(req.userId);

        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }


        const requestedVipLevel = req.query.vipLevel !== undefined ? parseInt(req.query.vipLevel) : (user.vipLevel || 0);

        const packages = await Package.find({
            isActive: true,
            vipLevel: requestedVipLevel
        }).sort({ duration: 1 });
        res.json(packages);
    } catch (error) {
        console.error('Get packages error:', error);
        res.status(500).json({ message: 'Server error' });
    }
});

// Get user's investment history (Lend Funding)
router.get('/my-investments', authMiddleware, async (req, res) => {
    try {
        const user = await User.findById(req.userId);
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        // Return investments sorted by date (newest first)
        const investments = user.investments.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

        res.json(investments);
    } catch (error) {
        console.error('Get my investments error:', error);
        res.status(500).json({ message: 'Server error' });
    }
});

// Create investment
router.post('/create', authMiddleware, async (req, res) => {
    try {
        const { packageId, amount } = req.body;

        // Validation
        const pkg = await Package.findById(packageId);
        if (!pkg) {
            return res.status(404).json({ message: 'Package not found' });
        }

        if (!pkg.isActive) {
            return res.status(400).json({ message: 'Package is not active' });
        }

        if (amount < pkg.minAmount || amount > pkg.maxAmount) {
            return res.status(400).json({
                message: `Investment amount must be between $${pkg.minAmount} and $${pkg.maxAmount}`
            });
        }

        const user = await User.findById(req.userId);

        // Check for existing active investment of the same package
        const hasActivePackage = user.investments.some(inv =>
            inv.package.name === pkg.name && inv.status === 'active'
        );

        if (hasActivePackage) {
            return res.status(400).json({
                message: `You already have an active investment for ${pkg.name}. Please wait for it to mature before investing again.`
            });
        }

        if (user.balance < amount) {
            return res.status(400).json({ message: 'Insufficient balance' });
        }

        // Deduct balance
        user.balance -= amount;

        // Calculate total return for record keeping
        const dailyReturn = amount * (pkg.dailyRate / 100);
        const totalReturn = amount + (dailyReturn * pkg.duration);

        // Add investment
        const startDate = new Date();
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + pkg.duration);

        user.investments.push({
            package: {
                packageNumber: pkg.duration, // Using duration as an identifier for now or add a code
                name: pkg.name,
                investmentAmount: amount,
                dailyEarning: dailyReturn,
                duration: pkg.duration,
                totalReturn: totalReturn
            },
            startDate: startDate,
            endDate: endDate,
            totalEarned: 0,
            status: 'active'
        });

        await user.save();

        // Notification: Investment Started
        await createNotification({
            userId: user._id,
            title: 'Investment Started',
            message: `You have successfully invested $${amount} in ${pkg.name}.`,
            type: 'investment',
            amount,
            relatedId: user.investments[user.investments.length - 1]._id
        });

        // Distribute team commissions to upline users
        try {
            await distributeCommissions(user, amount);
            console.log(`✅ Commissions distributed for investment of $${amount}`);
        } catch (commissionError) {
            console.error('Commission distribution error:', commissionError);
            // Don't fail the investment if commission fails
        }

        res.status(201).json({
            message: 'Investment created successfully',
            balance: user.balance,
            investment: user.investments[user.investments.length - 1]
        });

    } catch (error) {
        console.error('Create investment error:', error);
        res.status(500).json({ message: 'Server error' });
    }
});

// Get claimable income
router.get('/income', authMiddleware, async (req, res) => {
    try {
        const user = await User.findById(req.userId);
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        const now = new Date();
        let totalClaimable = 0;
        let claimableCount = 0;
        const activeIncome = [];

        // Check active investments for claimable income
        user.investments.forEach(inv => {
            if (inv.status === 'active') {
                const lastClaim = inv.lastEarningDate || inv.startDate;
                const hoursSince = (now - new Date(lastClaim)) / (1000 * 60 * 60);

                // Allow claim if 24 hours passed
                if (hoursSince >= 24) {
                    const days = Math.floor(hoursSince / 24);
                    const amount = days * inv.package.dailyEarning;

                    if (amount > 0) {
                        totalClaimable += amount;
                        claimableCount++;
                        activeIncome.push({
                            package: inv.package.name,
                            amount: amount,
                            days: days
                        });
                    }
                }
            }
        });

        res.json({
            totalClaimable,
            claimableCount,
            details: activeIncome,
            stats: {
                totalEarnings: user.totalEarnings,
                interestIncome: user.interestIncome,
                teamIncome: user.teamIncome,
                bonusIncome: user.bonusIncome
            }
        });
    } catch (error) {
        console.error('Get income error:', error);
        res.status(500).json({ message: 'Server error parsing income' });
    }
});

// Collect income
router.post('/collect', authMiddleware, async (req, res) => {
    try {
        const user = await User.findById(req.userId);
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        const now = new Date();
        let collectedTotal = 0;
        let completedPackages = [];

        // Iterate and collect
        user.investments.forEach(inv => {
            if (inv.status === 'active') {
                const lastClaim = inv.lastEarningDate || inv.startDate;
                const timeDiff = now - new Date(lastClaim);
                const hoursSince = timeDiff / (1000 * 60 * 60);

                // Income Collection Logic
                if (hoursSince >= 24) {
                    const days = Math.floor(hoursSince / 24);
                    const amount = days * inv.package.dailyEarning;

                    if (amount > 0) {
                        collectedTotal += amount;
                        inv.totalEarned += amount;

                        const lastDate = new Date(lastClaim);
                        lastDate.setDate(lastDate.getDate() + days); // Move forward by claimable days
                        inv.lastEarningDate = lastDate;
                    }
                }

                // Expiration Logic
                if (new Date(inv.endDate) <= now) {
                    inv.status = 'completed';
                    // Move Principal to Redeemable
                    user.redeemableBalance += inv.package.investmentAmount;
                    completedPackages.push(inv.package.name);

                    // Log completion
                    console.log(`[Invest] Package expired/completed: ${inv.package.name} for user ${user.phone}`);
                }
            }
        });

        if (collectedTotal > 0 || completedPackages.length > 0) {
            user.balance += collectedTotal;
            user.totalEarnings += collectedTotal;
            user.interestIncome += collectedTotal; // Track specifically as interest income
            await user.save();

            // Notification: Income Collected
            await createNotification({
                userId: user._id,
                title: 'Income Collected',
                message: `You have collected $${collectedTotal} from your daily earnings.`,
                type: 'investment',
                amount: collectedTotal
            });

            res.json({
                success: true,
                collected: collectedTotal,
                newBalance: user.balance,
                completed: completedPackages
            });
        } else {
            res.status(400).json({ message: 'No income available to collect yet' });
        }

    } catch (error) {
        console.error('Collect income error:', error);
        res.status(500).json({ message: 'Server error collecting income' });
    }
});

// Get assets summary
router.get('/assets', authMiddleware, async (req, res) => {
    try {
        const user = await User.findById(req.userId);
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        console.log(`[Assets] Request from User ID: ${req.userId}`);
        console.log(`[Assets] Found Database User: ${user.phone} (${user._id})`);
        console.log(`[Assets] Active Investments Count: ${user.investments.filter(i => i.status === 'active').length}`);
        console.log(`[Assets] Current Balance: ${user.balance}`);
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

        const now = new Date();
        let totalInvested = 0;
        let maturedAmount = 0;
        let maturedCount = 0;

        // Auto-process matured investments
        user.investments.forEach(inv => {
            if (inv.status === 'active' && new Date(inv.endDate) <= now) {
                // Investment has matured/completed
                inv.status = 'completed';
                // Move principal amount to redeemable balance
                user.redeemableBalance += inv.package.investmentAmount;
                maturedAmount += inv.package.investmentAmount;
                maturedCount++;

                console.log(`[Assets] Auto-matured investment: ${inv.package.name} - Principal: ${inv.package.investmentAmount} USDT`);
            }
        });

        // Save if any investments were matured
        if (maturedCount > 0) {
            await user.save();
            console.log(`[Assets] ${maturedCount} investments matured. Total moved to redeemable: ${maturedAmount} USDT. Current balance: ${user.balance}`);
        }

        // Calculate investment statistics AFTER maturity processing
        user.investments.forEach(inv => {
            if (inv.status === 'active') {
                if (inv.package && inv.package.investmentAmount) {
                    totalInvested += inv.package.investmentAmount;
                }
            }
        });

        const availableIncome = user.balance || 0;
        const redeemableAmount = user.redeemableBalance || 0;
        const totalAssets = totalInvested + availableIncome + redeemableAmount;

        res.json({
            totalAssets: totalAssets,
            availableIncome: availableIncome,
            lendingInvestments: totalInvested,
            redeemable: redeemableAmount,
            fundInProgress: totalInvested,
            fundRedeemable: redeemableAmount
        });
    } catch (error) {
        console.error('Get assets error:', error);
        res.status(500).json({ message: 'Server error fetching assets' });
    }
});

// Redeem matured assets
router.post('/redeem', authMiddleware, async (req, res) => {
    try {
        const user = await User.findById(req.userId);
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        if (user.redeemableBalance <= 0) {
            return res.status(400).json({ message: 'No assets available to redeem' });
        }

        const amountToRedeem = user.redeemableBalance;
        user.balance += amountToRedeem;
        user.redeemableBalance = 0;

        await user.save();

        res.json({
            success: true,
            message: 'Assets redeemed successfully',
            redeemed: amountToRedeem,
            newBalance: user.balance
        });
    } catch (error) {
        console.error('Redeem error:', error);
        res.status(500).json({ message: 'Server error redeeming assets' });
    }
});

export default router;
